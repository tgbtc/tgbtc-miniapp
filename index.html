<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>tgBTC Fi — Supply Realtime</title>
  <script defer src="https://telegram.org/js/telegram-web-app.js"></script>

  <style>
    :root{
      --bg:#0b0f17; --text:#e5e7eb; --muted:#94a3b8; --line:rgba(148,163,184,.18);
      --good:#22c55e; --warn:#f59e0b; --bad:#ef4444;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;background:var(--bg);color:var(--text)}
    .wrap{max-width:820px;margin:0 auto;padding:14px}

    .top{display:flex;align-items:center;justify-content:space-between;gap:10px;padding:6px 0 12px;}
    .brand{font-weight:950;letter-spacing:.4px;font-size:16px}

    .pill{
      display:flex;align-items:center;gap:8px;
      padding:8px 10px;border:1px solid var(--line);
      border-radius:999px;color:var(--muted);
      font-size:12px;background:rgba(255,255,255,.02);
      user-select:none;
    }
    .dot{font-size:12px;line-height:1}
    .mono{font-variant-numeric:tabular-nums}

    .grid{display:grid;grid-template-columns:1fr;gap:12px;}
    @media(min-width:640px){ .grid{grid-template-columns:1fr 1fr;} }

    .card{background:rgba(255,255,255,.02);border:1px solid var(--line);border-radius:16px;padding:12px;}
    .label{color:var(--muted);font-size:12px;margin-bottom:6px}
    .value{font-weight:950;font-size:22px;line-height:1.15;letter-spacing:.2px;word-break:break-word;}
    .sub{margin-top:8px;color:var(--muted);font-size:11px;line-height:1.35;}

    .supplyRow{display:flex;align-items:baseline;gap:10px;flex-wrap:wrap}
    .trendWrap{display:inline-flex;align-items:baseline;gap:6px}
    .arrow{font-weight:950;font-size:14px;line-height:1}
    .arrow.up{color:var(--good)}
    .arrow.down{color:var(--bad)}
    .delta{font-weight:900;font-size:12px}
    .delta.up{color:var(--good)}
    .delta.down{color:var(--bad)}
    .delta.flat{color:var(--text)} /* белый при 0 */

    .log{
      margin-top:10px;
      border-top:1px dashed var(--line);
      padding-top:10px;
      display:flex;
      flex-direction:column;
      gap:6px;
      font-size:12px;
      color:var(--muted);
    }
    .logLine{display:flex;align-items:baseline;justify-content:space-between;gap:10px}
    .tag{font-weight:900;color:var(--text)}
    .tag.good{color:var(--good)}
    .tag.bad{color:var(--bad)}
    .tag.warn{color:var(--warn)}
  </style>
</head>

<body>
  <div class="wrap">

    <div class="top">
      <div class="brand">tgBTC Fi • Realtime</div>

      <div class="pill">
        <span class="dot" id="netDot">●</span>
        <span id="netText">—</span>
        <span class="mono" id="netTime">--:--:--</span>
      </div>
    </div>

    <div class="grid">
      <div class="card">
        <div class="label">Количество tgBTC (total supply)</div>

        <div class="value mono supplyRow">
          <span id="supply">—</span>
          <span class="trendWrap">
            <span id="supplyArrow" class="arrow"></span>
            <span id="supplyDelta" class="delta flat">+0.00 tgBTC</span>
          </span>
        </div>

        <div class="sub" id="meta">Источник: TON Center (server) • testnet</div>

        <div class="log">
          <div class="logLine">
            <span>Статус:</span>
            <span id="statusTag" class="tag">—</span>
          </div>
          <div class="logLine">
            <span>Последнее изменение:</span>
            <span class="mono" id="lastChange">—</span>
          </div>
          <div class="logLine">
            <span>Обновление данных:</span>
            <span class="mono" id="lastFetch">—</span>
          </div>
          <div class="logLine">
            <span>Интервал опроса:</span>
            <span class="mono" id="pollEvery">—</span>
          </div>
          <div class="logLine">
            <span>Без изменений подряд:</span>
            <span class="mono" id="sameCount">0</span>
          </div>
        </div>
      </div>
    </div>

  </div>

  <script>
    const tg = window.Telegram?.WebApp;
    if (tg){ try{ tg.ready(); tg.expand(); }catch(e){} }

    const $ = (id) => document.getElementById(id);

    // ====== formatting ======
    function formatUnitsFixed(rawBig, decimals, fixed = 2){
      const neg = rawBig < 0n;
      const x = neg ? -rawBig : rawBig;

      const base = 10n ** BigInt(decimals);
      const i = x / base;
      const f = x % base;

      const fracAll = f.toString().padStart(decimals, "0");
      const fracFixed = fixed > 0 ? fracAll.slice(0, fixed).padEnd(fixed, "0") : "";

      return (neg ? "-" : "") + i.toString() + (fixed > 0 ? "." + fracFixed : "");
    }

    function formatDeltaFixed(deltaRawBig, decimals, fixed = 2){
      const sign = deltaRawBig > 0n ? "+" : deltaRawBig < 0n ? "-" : "";
      const abs = deltaRawBig < 0n ? -deltaRawBig : deltaRawBig;

      const base = 10n ** BigInt(decimals);
      const i = abs / base;
      const f = abs % base;

      const fracAll = f.toString().padStart(decimals, "0");
      const fracFixed = fixed > 0 ? fracAll.slice(0, fixed).padEnd(fixed, "0") : "";

      return sign + i.toString() + (fixed > 0 ? "." + fracFixed : "");
    }

    function setTrend(dir, deltaText){
      const arrow = $("supplyArrow");
      const delta = $("supplyDelta");

      if (dir === "up") {
        arrow.textContent = "▲";
        arrow.className = "arrow up";
        delta.textContent = `${deltaText} tgBTC`;
        delta.className = "delta up";
      } else if (dir === "down") {
        arrow.textContent = "▼";
        arrow.className = "arrow down";
        delta.textContent = `${deltaText} tgBTC`;
        delta.className = "delta down";
      } else {
        arrow.textContent = "";
        arrow.className = "arrow";
        delta.textContent = `+0.00 tgBTC`;
        delta.className = "delta flat";
      }
    }

    function setStatus(kind, text){
      const tag = $("statusTag");
      tag.textContent = text;
      tag.className = "tag " + (kind || "");
    }

    function fmtClock(){
      return new Date().toLocaleTimeString();
    }

    // ====== realtime polling with backoff ======
    const LS_KEY = "tgbtc_supply_raw_v2";
    const LS_LASTCHANGE = "tgbtc_supply_lastchange_v2";

    let lastSupplyRaw = null;
    let lastChangeAt = null;
    let sameInRow = 0;

    // polling interval logic
    let pollMs = 5000; // start 5s
    let timer = null;

    // restore
    try{
      const saved = localStorage.getItem(LS_KEY);
      if (saved) lastSupplyRaw = BigInt(saved);
      const savedLc = localStorage.getItem(LS_LASTCHANGE);
      if (savedLc) lastChangeAt = savedLc;
    }catch(e){}

    if (lastChangeAt) $("lastChange").textContent = lastChangeAt;

    function updateNet(ok){
      $("netDot").style.color = ok ? "var(--good)" : "var(--bad)";
      $("netText").textContent = ok ? "Online" : "Offline";
      $("netTime").textContent = fmtClock();
    }

    function scheduleNext(){
      clearTimeout(timer);
      $("pollEvery").textContent = (pollMs/1000).toFixed(0) + "s";
      timer = setTimeout(tick, pollMs);
    }

    async function tick(){
      try{
        const r = await fetch("/api/tgbtc-supply", { cache:"no-store" });
        const d = await r.json();
        $("lastFetch").textContent = fmtClock();

        if (!d?.ok) {
          updateNet(false);
          setStatus("bad", "Ошибка данных");
          // backoff on errors
          pollMs = Math.min(60000, Math.floor(pollMs * 1.5));
          scheduleNext();
          return;
        }

        updateNet(true);
        $("meta").textContent = `Источник: TON Center (server) • ${d.network} • ${d.symbol || "tgBTC"}`;

        const decimals = Number(d.decimals || 0);
        let raw = null;
        try{ raw = BigInt(String(d.supply_raw ?? "")); }catch(e){ raw = null; }

        if (raw === null) {
          setStatus("bad", "Парсинг supply");
          pollMs = Math.min(60000, Math.floor(pollMs * 1.5));
          scheduleNext();
          return;
        }

        // show main supply (2 decimals)
        $("supply").textContent = formatUnitsFixed(raw, decimals, 2);

        // compare + display what is happening
        if (lastSupplyRaw !== null) {
          const diff = raw - lastSupplyRaw;

          if (diff > 0n) {
            const deltaTxt = formatDeltaFixed(diff, decimals, 2);
            setTrend("up", deltaTxt);
            setStatus("good", "Supply растёт");
            sameInRow = 0;
            lastChangeAt = fmtClock();
            $("lastChange").textContent = lastChangeAt;

            // speed up on activity
            pollMs = 5000;
          }
          else if (diff < 0n) {
            const deltaTxt = formatDeltaFixed(diff, decimals, 2);
            setTrend("down", deltaTxt);
            setStatus("bad", "Supply уменьшается");
            sameInRow = 0;
            lastChangeAt = fmtClock();
            $("lastChange").textContent = lastChangeAt;

            pollMs = 5000;
          }
          else {
            setTrend("flat");
            sameInRow++;
            setStatus("", "Стабильно");
            pollMs = sameInRow >= 10 ? 30000 : sameInRow >= 4 ? 15000 : 5000;
          }
        } else {
          // first run
          setTrend("flat");
          setStatus("", "Стабильно");
        }

        $("sameCount").textContent = String(sameInRow);

        // store
        lastSupplyRaw = raw;
        try{
          localStorage.setItem(LS_KEY, raw.toString());
          if (lastChangeAt) localStorage.setItem(LS_LASTCHANGE, lastChangeAt);
        }catch(e){}

        scheduleNext();
      } catch (e) {
        updateNet(false);
        setStatus("bad", "Нет связи");
        pollMs = Math.min(60000, Math.floor(pollMs * 1.5));
        scheduleNext();
      }
    }

    // start
    $("pollEvery").textContent = (pollMs/1000).toFixed(0) + "s";
    tick();

    // pause/resume (экономит ресурсы)
    document.addEventListener("visibilitychange", () => {
      if (document.hidden) clearTimeout(timer);
      else scheduleNext();
    });
  </script>
</body>
</html>
