<!doctype html>
<html lang="ru">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>tgBTC Fi ‚Äî Realtime Supply</title>

<script defer src="https://telegram.org/js/telegram-web-app.js"></script>

<style>
:root{
  --bg:#0b0f17;
  --text:#e5e7eb;
  --muted:#94a3b8;
  --line:rgba(148,163,184,.18);
  --good:#22c55e;
  --warn:#f59e0b;
  --bad:#ef4444;
}
*{box-sizing:border-box}
body{
  margin:0;
  font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
  background:var(--bg);
  color:var(--text);
}
.wrap{max-width:820px;margin:0 auto;padding:14px}

/* top: keep title on the left, indicator on the right (same row) */
.top{
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:12px;
  padding-bottom:12px;
}
.brand{font-weight:950;font-size:16px}

/* compact indicator (no big pill look, but still neat) */
.statusInline{
  display:flex;
  align-items:center;
  gap:6px;
  font-size:12px;
  color:var(--muted);
  position:relative;
  white-space:nowrap;
}
.dot{font-size:12px}
.mono{font-variant-numeric:tabular-nums}

.helpBtn{
  width:18px;height:18px;
  display:inline-flex;align-items:center;justify-content:center;
  border-radius:999px;
  border:1px solid var(--line);
  font-weight:900;
  cursor:pointer;
  color:var(--muted);
  margin-left:2px;
}

.popover{
  position:absolute;
  right:0;
  top:calc(100% + 8px);
  width:260px;
  background:#0f172a;
  border:1px solid var(--line);
  border-radius:12px;
  padding:10px;
  font-size:11px;
  line-height:1.4;
  color:var(--muted);
  display:none;
  z-index:20;
}
.popover.show{display:block}
.popover b{color:var(--text)}

.card{
  background:rgba(255,255,255,.02);
  border:1px solid var(--line);
  border-radius:16px;
  padding:14px;
}
.label{font-size:12px;color:var(--muted)}
.value{
  margin-top:6px;
  font-weight:950;
  font-size:22px;
  display:flex;
  gap:10px;
  align-items:baseline;
}
.arrow{font-size:14px;font-weight:900}
.arrow.up{color:var(--good)}
.arrow.down{color:var(--bad)}

.delta{
  font-size:12px;
  font-weight:900;
}
.delta.up{color:var(--good)}
.delta.down{color:var(--bad)}
.delta.flat{color:var(--text)}

.sub{margin-top:8px;font-size:11px;color:var(--muted)}
</style>
</head>

<body>
<div class="wrap">

  <!-- TOP (title left, indicator right, same line) -->
  <div class="top">
    <div class="brand">tgBTC Fi ‚Ä¢ Realtime</div>

    <div class="statusInline" id="statusInline">
      <span class="dot" id="stDot">‚óè</span>
      <span id="stText">‚Äî</span>
      <span class="mono" id="stTime">--:--:--</span>
      <span class="helpBtn" id="helpBtn">?</span>

      <div class="popover" id="helpPop">
        <b>–û–∫–Ω–æ BTC ‚Üí tgBTC</b><br><br>
        üü¢ Active ‚Äî –∞–¥—Ä–µ—Å –≤–∏–¥–∏–º<br>
        üî¥ Hidden ‚Äî –ø–µ—Ä–≤—ã–µ 10 –º–∏–Ω—É—Ç<br>
        üî¥ Hidden ‚Äî –ø–æ—Å–ª–µ–¥–Ω–∏–µ 30 –º–∏–Ω—É—Ç<br><br>
        –¶–∏–∫–ª –∂–∏–≤—ë—Ç <b>1 —á–∞—Å</b>
      </div>
    </div>
  </div>

  <!-- SUPPLY CARD -->
  <div class="card">
    <div class="label">–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ tgBTC (total supply)</div>

    <div class="value mono">
      <span id="supply">‚Äî</span>
      <span id="supplyArrow" class="arrow"></span>
      <span id="supplyDelta" class="delta flat">+0.00 tgBTC</span>
    </div>

    <div class="sub" id="meta">–ò—Å—Ç–æ—á–Ω–∏–∫: TON Center (server) ‚Ä¢ ‚Äî ‚Ä¢ tgBTC</div>
  </div>

</div>

<script>
const $ = id => document.getElementById(id);

// ===== Telegram
const tg = window.Telegram?.WebApp;
if (tg){ try{ tg.ready(); tg.expand(); }catch{} }

// ===== Teleport window indicator (1h) ‚Äî sync by observation
const CYCLE = 60 * 60;      // 1 —á–∞—Å
const HIDE_FIRST = 10 * 60; // –ø–µ—Ä–≤—ã–µ 10 –º–∏–Ω—É—Ç —Å–∫—Ä—ã—Ç
const HIDE_LAST  = 30 * 60; // –ø–æ—Å–ª–µ–¥–Ω–∏–µ 30 –º–∏–Ω—É—Ç —Å–∫—Ä—ã—Ç

// –ù–∞–±–ª—é–¥–µ–Ω–∏–µ: –∞–¥—Ä–µ—Å –ø–æ—è–≤–∏–ª—Å—è, –∫–æ–≥–¥–∞ Teleport –ø–æ–∫–∞–∑—ã–≤–∞–ª 51:19
const OBS_TO_UPDATE = (51 * 60) + 19; // 51:19

const LS_OFFSET = "tgbtc_tp_offset_1h";

function fmt(sec){
  sec = Math.max(0, sec|0);
  const h = String((sec/3600)|0).padStart(2,'0');
  const m = String((sec%3600/60)|0).padStart(2,'0');
  const s = String((sec%60)|0).padStart(2,'0');
  return `${h}:${m}:${s}`;
}

let OFFSET = 0;

// –ö–∞–ª–∏–±—Ä–æ–≤–∫–∞: –≤ –º–æ–º–µ–Ω—Ç –Ω–∞–±–ª—é–¥–µ–Ω–∏—è "toUpdate = 51:19" —Å—á–∏—Ç–∞–µ–º, —á—Ç–æ —ç—Ç–æ –Ω–∞—á–∞–ª–æ Active (pos = HIDE_FIRST)
(function initOffset(){
  try{
    const saved = localStorage.getItem(LS_OFFSET);
    if (saved !== null){
      OFFSET = Number(saved) || 0;
      return;
    }
  }catch{}

  const now = (Date.now()/1000)|0;

  // pos = CYCLE - toUpdate
  const posFromObs = (CYCLE - OBS_TO_UPDATE);

  // —Ö–æ—Ç–∏–º pos == HIDE_FIRST
  let off = (HIDE_FIRST - posFromObs) - (now % CYCLE);

  off = ((off % CYCLE) + CYCLE) % CYCLE;

  OFFSET = off;
  try{ localStorage.setItem(LS_OFFSET, String(OFFSET)); }catch{}
})();

function updateWindow(){
  const now = (Date.now()/1000)|0;
  let pos = (now + OFFSET) % CYCLE;
  if (pos < 0) pos += CYCLE;

  const toUpdate = CYCLE - pos; // "–≤—Ä–µ–º—è –¥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è" (–∫–∞–∫ –≤ Teleport)

  // üî¥ –ø–µ—Ä–≤—ã–µ 10 –º–∏–Ω—É—Ç –ø–æ—Å–ª–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
  if (pos < HIDE_FIRST){
    stDot.style.color = 'var(--bad)';
    stText.textContent = 'üî¥ Hidden';
    stTime.textContent = fmt(HIDE_FIRST - pos);
    return;
  }

  // üî¥ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 30 –º–∏–Ω—É—Ç (–í–ê–ñ–ù–û: –æ—Ä–∏–µ–Ω—Ç–∏—Ä—É–µ–º—Å—è –ø–æ toUpdate)
  // Teleport –º–æ–∂–µ—Ç —Å–∫—Ä—ã–≤–∞—Ç—å —É–∂–µ –Ω–∞ 30:01, –µ—Å–ª–∏ –Ω—É–∂–Ω–æ ‚Äî –ø–æ–º–µ–Ω—è–π –Ω–∞ (HIDE_LAST + 1)
  if (toUpdate <= HIDE_LAST){
    stDot.style.color = 'var(--bad)';
    stText.textContent = 'üî¥ Hidden';
    stTime.textContent = fmt(toUpdate);
    return;
  }

  // üü¢ Active
  stDot.style.color = 'var(--good)';
  stText.textContent = 'üü¢ Active';
  stTime.textContent = fmt(toUpdate);
}

setInterval(updateWindow, 1000);
updateWindow();

// popover
helpBtn.onclick=e=>{
  e.stopPropagation();
  helpPop.classList.toggle('show');
};
document.onclick=()=>helpPop.classList.remove('show');

// ===== Supply realtime (persist last change across reload)
const LS_CUR  = "tgbtc_supply_raw_cur";
const LS_PREV = "tgbtc_supply_raw_prev";

let curRaw = null;
let prevRaw = null;

try{
  const c = localStorage.getItem(LS_CUR);
  const p = localStorage.getItem(LS_PREV);
  if (c) curRaw = BigInt(c);
  if (p) prevRaw = BigInt(p);
}catch{}

function format2(raw,dec){
  const b=10n**BigInt(dec);
  const i=raw/b;
  const f=(raw%b).toString().padStart(dec,"0").slice(0,2);
  return `${i}.${f}`;
}
function delta2(diff,dec){
  const sign=diff>0n?"+":diff<0n?"-":"";
  diff=diff<0n?-diff:diff;
  const b=10n**BigInt(dec);
  const i=diff/b;
  const f=(diff%b).toString().padStart(dec,"0").slice(0,2);
  return `${sign}${i}.${f}`;
}

function renderDelta(diff, dec){
  if (diff > 0n){
    supplyArrow.textContent="‚ñ≤";
    supplyArrow.className="arrow up";
    supplyDelta.textContent=`${delta2(diff,dec)} tgBTC`;
    supplyDelta.className="delta up";
  } else if (diff < 0n){
    supplyArrow.textContent="‚ñº";
    supplyArrow.className="arrow down";
    supplyDelta.textContent=`${delta2(diff,dec)} tgBTC`;
    supplyDelta.className="delta down";
  } else {
    supplyArrow.textContent="";
    supplyDelta.textContent="+0.00 tgBTC";
    supplyDelta.className="delta flat";
  }
}

async function updateSupply(){
  const r=await fetch("/api/tgbtc-supply",{cache:"no-store"});
  const d=await r.json();
  if(!d?.ok) return;

  const raw = BigInt(d.supply_raw);
  const dec = Number(d.decimals || 0);

  // supply number (2 decimals)
  supply.textContent = format2(raw, dec);

  // if first ever run: just set curRaw
  if (curRaw === null) {
    curRaw = raw;
    try{ localStorage.setItem(LS_CUR, curRaw.toString()); }catch{}
    renderDelta(0n, dec);
  } else {
    const diffNow = raw - curRaw;

    if (diffNow !== 0n) {
      // update prev/cur so last change persists after reload
      prevRaw = curRaw;
      curRaw = raw;

      try{
        localStorage.setItem(LS_PREV, prevRaw.toString());
        localStorage.setItem(LS_CUR, curRaw.toString());
      }catch{}

      // show the change that just happened
      renderDelta(diffNow, dec);
    } else {
      // no new change right now
      // BUT if we have a persisted last change (cur != prev), keep showing it after reload too
      if (prevRaw !== null && curRaw !== prevRaw) {
        const lastChange = curRaw - prevRaw;
        renderDelta(lastChange, dec);
      } else {
        renderDelta(0n, dec);
      }
    }
  }

  meta.textContent=`–ò—Å—Ç–æ—á–Ω–∏–∫: TON Center (server) ‚Ä¢ ${d.network} ‚Ä¢ ${d.symbol || "tgBTC"}`;
}

updateSupply();
setInterval(updateSupply, 5000);

</script>
</body>
</html>
