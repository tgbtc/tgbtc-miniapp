<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <title>tgBTC Timing App</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    body {
      margin: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont;
      background: #0f172a;
      color: #e5e7eb;
      display: flex;
      justify-content: center;
      align-items: center;
      height: 100vh;
      text-align: center;
    }
    .box {
      padding: 26px;
      border-radius: 18px;
      background: #020617;
      box-shadow: 0 0 40px rgba(0,0,0,0.4);
      max-width: 360px;
      width: 100%;
    }
    h1 {
      margin-bottom: 6px;
      font-size: 22px;
    }
    .status {
      font-size: 18px;
      margin: 10px 0;
    }
    .timer {
      font-size: 28px;
      font-weight: bold;
      margin: 12px 0;
    }
    .hint {
      font-size: 13px;
      opacity: 0.85;
      margin-top: 6px;
      line-height: 1.4;
    }
    .note {
      font-size: 12px;
      opacity: 0.6;
      margin-top: 12px;
      line-height: 1.4;
    }
    .btn {
      margin-top: 14px;
      padding: 12px;
      width: 100%;
      border-radius: 12px;
      background: #2563eb;
      color: #fff;
      border: none;
      font-size: 15px;
      font-weight: 600;
      cursor: pointer;
    }
    .btn.secondary {
      background: #334155;
    }
    .btn:active {
      transform: scale(0.98);
    }
  </style>
</head>
<body>

<div class="box">
  <h1>tgBTC Timing</h1>

  <div id="status" class="status">â€”</div>
  <div id="timer" class="timer">--:--:--</div>
  <div id="hint" class="hint"></div>

  <button class="btn" onclick="openTeleport()">
    Open TON Teleport
  </button>

  <button class="btn secondary" id="notifyBtn" onclick="toggleNotify()">
    ðŸ”” Enable notification
  </button>

  <div class="note">
    This app does not perform transactions.<br>
    Timing is indicative â€” always confirm on TON Teleport.
  </div>
</div>

<script>
  const tg = window.Telegram.WebApp;
  tg.ready();
  tg.expand();

  // ===== CONFIG =====
  const CYCLE = 4 * 60 * 60;      // 4 hours
  const WAIT_START = 15 * 60;     // buffer at start
  const WAIT_END = 40 * 60;       // buffer at end

  function formatTime(sec) {
    const h = String(Math.floor(sec / 3600)).padStart(2, '0');
    const m = String(Math.floor((sec % 3600) / 60)).padStart(2, '0');
    const s = String(sec % 60).padStart(2, '0');
    return `${h}:${m}:${s}`;
  }

  function updateNotifyUI() {
    const enabled = localStorage.getItem("notify") === "true";
    const btn = document.getElementById("notifyBtn");

    btn.textContent = enabled
      ? "ðŸ”• Disable notification"
      : "ðŸ”” Enable notification";
  }

  function toggleNotify() {
    const enabled = localStorage.getItem("notify") === "true";

    if (enabled) {
      localStorage.removeItem("notify");
      alert("ðŸ”• Notification disabled.");
    } else {
      localStorage.setItem("notify", "true");
      localStorage.removeItem("notified");
      alert(
        "ðŸ”” Notification enabled.\n\n" +
        "You will be notified once when the safe window opens."
      );
    }

    updateNotifyUI();
  }

  function checkNotification(now, safeStart) {
    const notifyEnabled = localStorage.getItem("notify") === "true";
    const alreadyNotified = localStorage.getItem("notified") === "true";

    if (notifyEnabled && !alreadyNotified && now >= safeStart) {
      alert(
        "ðŸŸ¢ Safe window is open!\n\n" +
        "You can send BTC now.\n\n" +
        "This notification was disabled automatically."
      );

      localStorage.removeItem("notify");
      localStorage.setItem("notified", "true");
      updateNotifyUI();
    }
  }

  function update() {
    const now = Math.floor(Date.now() / 1000);
    const cycleStart = now - (now % CYCLE);
    const cycleEnd = cycleStart + CYCLE;

    const safeStart = cycleStart + WAIT_START;
    const safeEnd = cycleEnd - WAIT_END;

    const statusEl = document.getElementById("status");
    const timerEl = document.getElementById("timer");
    const hintEl = document.getElementById("hint");

    // reset notification flag at new cycle
    if (now < safeStart) {
      localStorage.removeItem("notified");
    }

    if (now < safeStart) {
      const t = safeStart - now;
      statusEl.textContent = "ðŸŸ¡ ÐŸÐ¾Ð´Ð¾Ð¶Ð´Ð¸ â€” Ñ†Ð¸ÐºÐ» Ð½Ð°Ñ‡Ð°Ð»ÑÑ";
      timerEl.textContent = formatTime(t);
      hintEl.textContent =
        "Ð”Ð¾ Ð½Ð°Ñ‡Ð°Ð»Ð° Ð±ÐµÐ·Ð¾Ð¿Ð°ÑÐ½Ð¾Ð³Ð¾ Ð¾ÐºÐ½Ð°. ÐÐµ Ð¾Ñ‚Ð¿Ñ€Ð°Ð²Ð»ÑÐ¹ BTC ÑÐµÐ¹Ñ‡Ð°Ñ.";
    }
    else if (now >= safeStart && now <= safeEnd) {
      const t = safeEnd - now;
      statusEl.textContent = "ðŸŸ¢ ÐœÐ¾Ð¶Ð½Ð¾ Ð¾Ñ‚Ð¿Ñ€Ð°Ð²Ð»ÑÑ‚ÑŒ BTC";
      timerEl.textContent = formatTime(t);
      hintEl.textContent =
        "Ð­Ñ‚Ð¾ Ð²Ñ€ÐµÐ¼Ñ, ÐºÐ¾Ñ‚Ð¾Ñ€Ð¾Ðµ Ð¾ÑÑ‚Ð°Ð»Ð¾ÑÑŒ Ð´Ð»Ñ Ð±ÐµÐ·Ð¾Ð¿Ð°ÑÐ½Ð¾Ð¹ Ð¾Ñ‚Ð¿Ñ€Ð°Ð²ÐºÐ¸ BTC.";
    }
    else {
      const t = cycleEnd - now;
      statusEl.textContent = "ðŸ”´ ÐžÐ¿Ð°ÑÐ½Ð¾ â€” Ð°Ð´Ñ€ÐµÑ ÑÐºÐ¾Ñ€Ð¾ ÑÐ¼ÐµÐ½Ð¸Ñ‚ÑÑ";
      timerEl.textContent = formatTime(t);
      hintEl.textContent =
        "Ð–Ð´Ð¸ ÑÐ»ÐµÐ´ÑƒÑŽÑ‰Ð¸Ð¹ Ñ†Ð¸ÐºÐ», Ñ‡Ñ‚Ð¾Ð±Ñ‹ Ð¸Ð·Ð±ÐµÐ¶Ð°Ñ‚ÑŒ Ð±Ð»Ð¾ÐºÐ¸Ñ€Ð¾Ð²ÐºÐ¸.";
    }

    checkNotification(now, safeStart);
  }

  function openTeleport() {
    window.open("https://sandbox.teleport.tg/app/deposit/new", "_blank");
  }

  updateNotifyUI();
  update();
  setInterval(update, 1000);
</script>

</body>
</html>
